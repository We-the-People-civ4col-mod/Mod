#!/usr/bin/perl -w


use strict;
use warnings;

package XMLlists;

use File::Compare;
use File::Copy;
use File::Slurp;

use Exporter;
our @ISA= qw( Exporter );
our @EXPORT = qw(
	getAutoDir
	getPythonDir
	getMapDir
	getSourceDir
	getFileWithPath
	getEnumFiles
	getNumFunction
	getInfo
	getXMLKeywords
	isAlwaysHardcodedEnum
	hasNoTypeTag
	getNoType
	updateAutoFile
	isTwoLevelFile
	isDllExport
	getXMLlocation
	writeFile
);

# first is a list of files with hardcoded Type settings in the DLL.
# this means changing any of those files in a way that will alter the list of Types will require a recompile.
sub isAlwaysHardcodedEnum
{
	my $type = shift;
	
	return 1 if $type eq "DomainTypes";
	return 1 if $type eq "UnitAITypes";
	return 1 if $type eq "InvisibleTypes";
	return 1 if $type eq "GameOptionTypes";
	return 1 if $type eq "PlayerOptionTypes";
	return 1 if $type eq "TradeScreenTypes";
	return 1 if $type eq "TerrainTypes";
	return 1 if $type eq "YieldTypes";
	return 1 if $type eq "AutomateTypes";
	return 1 if $type eq "CommandTypes";
	return 1 if $type eq "ControlTypes";
	return 1 if $type eq "MissionTypes";
	return 1 if $type eq "HurryTypes";
	return 1 if $type eq "RouteTypes";
	return 1 if $type eq "AttitudeTypes";
	return 1 if $type eq "MemoryTypes";
	return 1 if $type eq "CalendarTypes";
	return 1 if $type eq "DenialTypes";
	return 1 if $type eq "MultiplayerOptionTypes";
	return 1 if $type eq "ForceControlTypes";
	return 1 if $type eq "GraphicOptionTypes";
	return 1 if $type eq "InterfaceModeTypes";
	return 1 if $type eq "EuropeTypes";
	
	return 0;
}

sub getXMLlocation()
{
	return "../Assets/XML/";
}

sub getAutoDir
{
	return "DLLSources/autogenerated/";
}

sub getPythonDir
{
	return "../Assets/Python/";
}

sub getMapDir
{
	return "../PrivateMaps/";
}

sub getSourceDir
{
	return "DLLSources/";
}

sub getFileWithPath
{
	my $file = shift;
	
	foreach my $prefix (getXMLlocation(), getXMLlocation())
	{
		my $path = $prefix . $file;
		return $path if -e $path;
	}
	return undef;
}

sub getBasename
{
	my $basename = shift;
	
	my $index = index($basename, "Info");
	return substr($basename, 0, $index) if $index != -1;
	
	$index = index($basename, "s.");
	return substr($basename, 0, $index) if $index != -1;
	
	$index = index($basename, ".");
	return substr($basename, 0, $index) if $index != -1;
	
	return $basename;
}

sub getXMLKeywords
{
	my $file = shift;
	
	# first the non-standard enums. A few doesn't apply to the standard naming rules.
	return ("WorldSize", "WorldSizeTypes", "WORLDSIZE") if $file eq "GameInfo/CIV4WorldInfo.xml";
	
	my $basename = $file;
	my $enum = ""; # needs a buffer variable. The contents will not be used.
	($enum, $basename) = split("/", $file) if index($file, "/") != -1;
	$basename = substr($basename, 4) if lc(substr($basename, 0, 4)) eq "civ4";
	$basename = getBasename($basename);
	
	$enum = $basename . "Types";
	my $TYPE = uc($basename);
	
	# rename types. Not all apply to the standard
	$TYPE = "CIVIC_OPTION" if $file eq "CivEffects/CIV4CivicOptionInfos.xml";
	$TYPE = "LEADER" if $file eq "Civilizations/CIV4LeaderHeadInfos.xml";
	$TYPE = "FATHER_POINT" if $file eq "GameInfo/CIV4FatherPointInfos.xml";
	
	if ($file eq "BasicInfos/CIV4BasicInfos.xml")
	{
		$basename = "Concept";
		$enum = "ConceptTypes";
		$TYPE = "CONCEPT";
	}
	
	if ($file eq "CivEffects/CIV4CivEffectsInfos.xml")
	{
		$basename = "CivEffect";
		$enum = "CivEffectTypes";
		$TYPE = "CIV_EFFECT";
	}
	
	if ($file eq "Civilizations/CIV4UnitArtStyleTypeInfos.xml")
	{
		$enum = "UnitArtStyleTypes";
		$TYPE = "UNIT_ARTSTYLE";
	}
	
	if ($file eq "Interface/CIV4ColorVals.xml")
	{
		$basename = "Color";
		$enum = "ColorTypes";
		$TYPE = "COLOR";
	}
	if ($file eq "Terrain/CIV4TerrainSettings.xml")
	{
		$basename = "Landscape";
		$enum = "LandscapeTypes";
		$TYPE = "LANDSCAPE";
	}
	
	
	
	$enum = "MultiplayerOptionTypes" if $file eq "GameInfo/CIV4MPOptionInfos.xml";
	
	return ($basename, $enum, $TYPE);
}

sub getNoType
{
	my $type = shift;
	
	return "NO_FATHER_POINT_TYPE" if $type eq "FATHER_POINT";
	return "ENTITY_EVENT_NONE" if $type eq "ENTITYEVENT";
	
	return "NO_" . $type;
}

sub getNumFunction
{
	my $basename = shift;

	return "m_paAttitudeInfos.size()"   if $basename eq "Attitude";
	return "NUM_BUILD_TYPES"            if $basename eq "Build";
	return "m_paCivEffectInfo.size()"   if $basename eq "CivEffect";
	return "m_paDomainInfo.size()"      if $basename eq "Domain";
	return "m_paGraphicOptionInfos.size()" if $basename eq "GraphicOption";
	return "GC.getNumMainMenus()"       if $basename eq "MainMenu";
	return "GC.m_paInterfaceModeInfo.size()" if $basename eq "InterfaceMode";
	return "m_paMemoryInfos.size()"     if $basename eq "Memory";
	return "GC.getNumLandscapeInfos()"  if $basename eq "Landscape";
	return "m_paUnitAIInfos.size()"     if $basename eq "UnitAI";
	return "GC.getNumWorldInfos()"      if $basename eq "WorldSize";
	return "m_paYieldInfo.size()"       if $basename eq "Yield";
	
	return "GC.getNum" . $basename . "Infos()";
}

sub getInfo
{
	my $basename = shift;

	return "GC.getWorldInfo" if $basename eq "WorldSize";
	
	return "GC.get" . $basename . "Info";
}

sub isTwoLevelFile
{
	my $file = shift;
	
	return 1 if $file eq "CivEffects/CIV4CivEffectsInfos.xml";
	return 1 if $file eq "Events/CIV4AchieveInfos.xml";
	
	return 0;
}

sub getEnumFiles
{
	my @list = ();
	
	push(@list, "Art/CIV4MainMenus.xml");
	push(@list, "Art/CIV4RiverModelInfos.xml");
	push(@list, "Art/Civ4RouteModelInfos.xml");
	
	push(@list, "BasicInfos/CIV4AttitudeInfos.xml");
	push(@list, "BasicInfos/CIV4BasicInfos.xml");
	push(@list, "BasicInfos/CIV4CalendarInfos.xml");
	push(@list, "BasicInfos/CIV4DenialInfos.xml");
	push(@list, "BasicInfos/CIV4DomainInfos.xml");
	push(@list, "BasicInfos/CIV4FatherCategoryInfos.xml");
	push(@list, "BasicInfos/CIV4InvisibleInfos.xml");
	push(@list, "BasicInfos/CIV4MemoryInfos.xml");
	push(@list, "BasicInfos/CIV4MonthInfos.xml");
	push(@list, "BasicInfos/CIV4SeasonInfos.xml");
	push(@list, "BasicInfos/CIV4UnitAIInfos.xml");
	push(@list, "BasicInfos/CIV4UnitCombatInfos.xml");
	
	push(@list, "Buildings/CIV4BuildingClassInfos.xml");
	push(@list, "Buildings/CIV4BuildingInfos.xml");
	push(@list, "Buildings/CIV4SpecialBuildingInfos.xml");
	
	push(@list, "CivEffects/CIV4CivEffectsInfos.xml");
	
	push(@list, "Civilizations/CIV4AlarmInfos.xml");
	push(@list, "Civilizations/CIV4CivilizationInfos.xml");
	push(@list, "Civilizations/CIV4LeaderHeadInfos.xml");
	push(@list, "Civilizations/CIV4TraitInfos.xml");
	push(@list, "Civilizations/CIV4UnitArtStyleTypeInfos.xml");
	
	push(@list, "Events/CIV4AchieveInfos.xml");
	push(@list, "Events/CIV4EventInfos.xml");
	push(@list, "Events/CIV4EventTriggerInfos.xml");
	
	push(@list, "GameInfo/CIV4CivicInfos.xml");
	push(@list, "GameInfo/CIV4CivicOptionInfos.xml");
	push(@list, "GameInfo/CIV4ClimateInfo.xml");
	push(@list, "GameInfo/CIV4CultureLevelInfo.xml");
	push(@list, "GameInfo/CIV4CursorInfo.xml");
	push(@list, "GameInfo/CIV4DiplomacyInfos.xml");
	push(@list, "GameInfo/CIV4EmphasizeInfo.xml");
	push(@list, "GameInfo/CIV4EraInfos.xml");
	push(@list, "GameInfo/CIV4EuropeInfo.xml");
	push(@list, "GameInfo/CIV4FatherInfos.xml");
	push(@list, "GameInfo/CIV4FatherPointInfos.xml");
	push(@list, "GameInfo/CIV4ForceControlInfos.xml");
	push(@list, "GameInfo/CIV4GameOptionInfos.xml");
	push(@list, "GameInfo/CIV4GameSpeedInfo.xml");
	push(@list, "GameInfo/CIV4GoodyInfo.xml");
	push(@list, "GameInfo/CIV4GraphicOptionInfos.xml");
	push(@list, "GameInfo/CIV4HandicapInfo.xml");
	push(@list, "GameInfo/CIV4Hints.xml");
	push(@list, "GameInfo/CIV4HurryInfo.xml");
	push(@list, "GameInfo/CIV4MPOptionInfos.xml");
	push(@list, "GameInfo/CIV4PlayerOptionInfos.xml");
	push(@list, "GameInfo/CIV4SeaLevelInfo.xml");
	push(@list, "GameInfo/CIV4TurnTimerInfo.xml");
	push(@list, "GameInfo/CIV4TradeScreenInfo.xml");
	push(@list, "GameInfo/CIV4VictoryInfo.xml");
	push(@list, "GameInfo/CIV4WorldInfo.xml");
	
	push(@list, "Interface/CIV4ColorVals.xml");
	push(@list, "Interface/CIV4InterfaceModeInfos.xml");
	push(@list, "Interface/CIV4PlayerColorInfos.xml");
	push(@list, "Interface/CIV4SlideShowInfos.xml");
	push(@list, "Interface/CIV4SlideShowRandomInfos.xml");
	push(@list, "Interface/CIV4WorldPickerInfos.xml");
	
	push(@list, "Misc/CIV4AttachableInfos.xml");
	#push(@list, "Misc/CIV4CameraOverlayInfos.xml");
	push(@list, "Misc/CIV4DetailManager.xml");
	push(@list, "Misc/CIV4EffectInfos.xml");
	push(@list, "Misc/CIV4RouteInfos.xml");
	push(@list, "Misc/CIV4TerrainPlaneInfos.xml");
	push(@list, "Misc/CIV4WaterPlaneInfos.xml");
	
	push(@list, "Terrain/CIV4BonusInfos.xml");
	push(@list, "Terrain/CIV4FeatureInfos.xml");
	push(@list, "Terrain/CIV4ImprovementInfos.xml");
	push(@list, "Terrain/CIV4TerrainInfos.xml");
	push(@list, "Terrain/CIV4TerrainSettings.xml");
	push(@list, "Terrain/CIV4YieldInfos.xml");
	
	#push(@list, "Units/Civ4AnimationInfos.xml");
	#push(@list, "Units/Civ4AnimationPathInfos.xml");
	push(@list, "Units/CIV4AutomateInfos.xml");
	push(@list, "Units/CIV4BuildInfos.xml");
	push(@list, "Units/CIV4CommandInfos.xml");
	push(@list, "Units/Civ4EntityEventInfos.xml");
	push(@list, "Units/CIV4ControlInfos.xml");
	push(@list, "Units/CIV4FormationInfos.xml");
	push(@list, "Units/CIV4MissionInfos.xml");
	push(@list, "Units/CIV4ProfessionInfos.xml");
	push(@list, "Units/CIV4PromotionInfos.xml");
	push(@list, "Units/CIV4SpecialUnitInfos.xml");
	push(@list, "Units/CIV4UnitClassInfos.xml");
	push(@list, "Units/CIV4UnitInfos.xml");
	
	return @list;
}

sub hasNoTypeTag
{
	my $type = shift;
	
	return 1 if $type eq "Art/CIV4RiverModelInfos.xml";
	return 1 if $type eq "Art/Civ4RouteModelInfos.xml";
	
	return 1 if $type eq "GameInfo/CIV4Hints.xml";
	
	return 1 if $type eq "Interface/CIV4SlideShowInfos.xml";
	return 1 if $type eq "Interface/CIV4SlideShowRandomInfos.xml";
	return 1 if $type eq "Interface/CIV4WorldPickerInfos.xml";
	
	return 1 if $type eq "Misc/CIV4CameraOverlayInfos.xml";
	return 1 if $type eq "Misc/CIV4DetailManager.xml";
	return 1 if $type eq "Misc/CIV4TerrainPlaneInfos.xml";
	return 1 if $type eq "Misc/CIV4WaterPlaneInfos.xml";
	
	return 1 if $type eq "Units/CIV4FormationInfos.xml";
	
	return 0;
}

sub isDllExport
{
	my $type = shift;
	
	return 1 if $type eq "AlarmTypes";
	return 1 if $type eq "AutomateTypes";
	return 1 if $type eq "BonusTypes";
	return 1 if $type eq "BuildingClassTypes";
	return 1 if $type eq "BuildingTypes";
	return 1 if $type eq "BuildTypes";
	return 1 if $type eq "CivicTypes";
	return 1 if $type eq "CivicOptionTypes";
	return 1 if $type eq "CivilizationTypes";
	return 1 if $type eq "ClimateTypes";
	return 1 if $type eq "ConceptTypes";
	return 1 if $type eq "ControlTypes";
	return 1 if $type eq "CultureLevelTypes";
	return 1 if $type eq "DomainTypes";
	return 1 if $type eq "EffectTypes";
	return 1 if $type eq "EmphasizeTypes";
	return 1 if $type eq "EraTypes";
	return 1 if $type eq "EventTriggerTypes";
	return 1 if $type eq "EventTypes";
	return 1 if $type eq "EuropeTypes";
	return 1 if $type eq "FatherCategoryTypes";
	return 1 if $type eq "FatherPointTypes";
	return 1 if $type eq "FatherTypes";
	return 1 if $type eq "FeatureTypes";
	return 1 if $type eq "GameOptionTypes";
	return 1 if $type eq "GameSpeedTypes";
	return 1 if $type eq "GoodyTypes";
	return 1 if $type eq "HandicapTypes";
	return 1 if $type eq "HurryTypes";
	return 1 if $type eq "ImprovementTypes";
	return 1 if $type eq "InvisibleTypes";
	return 1 if $type eq "LeaderHeadTypes";
	return 1 if $type eq "MissionTypes";
	return 1 if $type eq "PlayerOptionTypes";
	return 1 if $type eq "ProfessionTypes";
	return 1 if $type eq "PromotionTypes";
	return 1 if $type eq "RouteTypes";
	return 1 if $type eq "SeaLevelTypes";
	return 1 if $type eq "SpecialBuildingTypes";
	return 1 if $type eq "TerrainTypes";
	return 1 if $type eq "TraitTypes";
	return 1 if $type eq "UnitAITypes";
	return 1 if $type eq "UnitClassTypes";
	return 1 if $type eq "UnitCombatTypes";
	return 1 if $type eq "UnitTypes";
	return 1 if $type eq "VictoryTypes";
	return 1 if $type eq "WorldSizeTypes";
	return 1 if $type eq "YieldTypes";


	return 0
}

sub updateAutoFile
{
	my $FILE_TMP = shift;
	my $FILE = substr($FILE_TMP, 0, -4);

	die "Missing .tmp extension on temp auto file.\n" unless substr($FILE_TMP, -4) eq ".tmp";

	if (not -e $FILE or compare($FILE, $FILE_TMP) != 0)
	{
		# file is outdated or missing. Move the temp file
		# copying forces a complete recompile. It really should only be done if something changed.
		copy($FILE_TMP, $FILE);
	}
}

sub writeFile
{
	my $file = shift;
	my $text = shift;
	
	if (-e $file)
	{
		my $file_content = read_file($file);
		# return if the two files are identical
		# updating anyway will for an unneeded recompilation
		return if $file_content eq $$text;
	}

	open (my $output_file, "> " . $file) or die "Can't open file " . $file . "\n" . $!;
	print $output_file $$text;
	close $output_file;
}
